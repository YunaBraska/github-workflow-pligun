name: "DEPLOY [JAVA]"
#type: Workflow Trigger

on:
  pull_request_target:
    types: [ closed ]
    branches:
      - main
      - master
      - default
    paths:
      #  trigger ALL files (wildcard that matches any file or folder)
      - '**'
      #  trigger not when .yml and .md files that are not located in the .github folder
      - '!/.github/**/*.yml'
      - '!/.github/**/*.md'
  workflow_dispatch:
    inputs:
      ref:
        type: string
        description: "[ref] branch, tag or commit to checkout e.g. feature or rollback"
        required: false
      dest:
        type: choice
        description: "[dest] destination environment e.g. ps=production or mtp=staging"
        required: false
        default: 'mtp'
        options:
          - mtp
          - ps
      skip_test:
        type: choice
        required: false
        description: "[skip_test] skips tests when 'true'"
        default: 'false'
        options:
          - 'true'
          - 'false'
      region:
        type: choice
        description: "[region] aws region"
        required: false
        default: 'eu-central-1'
        options:
          - eu-central-1
      registry:
        type: choice
        description: "[repo] aws container registry"
        required: false
        default: 'dkr.ecr.eu-central-1.amazonaws.com'
        options:
          - dkr.ecr.eu-central-1.amazonaws.com
      AWS_ACCOUNT_ID:
        type: string
        required: false
        description: "[AWS_ACCOUNT_ID] aws alternative account id (should be better stored in secrets)"

jobs:
  local_0:
    name: "Tests Java"
    uses: ./
    with:
      deep: ${{ inputs.ref }}
      jv-fallback: ${{ inputs.skip_test }}
      INVALID: ${{ inputs.skip_test }}
    secrets: inherit
  local_1:
    name: "Tests Java"
    uses: ./action.yml
    with:
      deep: ${{ inputs.ref }}
      jv-fallback: ${{ inputs.skip_test }}
      INVALID: ${{ inputs.skip_test }}
    secrets: inherit
  local_2:
    name: "Tests Java"
    uses: ./.github/my_action
    with:
      deep: ${{ inputs.ref }}
      jv-fallback: ${{ inputs.skip_test }}
    secrets: inherit
  local_3:
    name: "Tests Java"
    uses: ./.github/my_action/action.yml
    with:
      deep: ${{ inputs.ref }}
      jv-fallback: ${{ inputs.skip_test }}
    secrets: inherit
    INVALID: ${{ inputs.skip_test }}
  deploy_java:
    needs: test_java
    name: "Deploy Java"
    uses: actions/cache/save@v3
    secrets: inherit
    with:
      ref: ${{ inputs.ref }}
      dest: ${{ inputs.dest }}
      region: ${{ inputs.region }}
      registry: ${{ inputs.registry }}
      AWS_ACCOUNT_ID: ${{ inputs.AWS_ACCOUNT_ID }}


